<!DOCTYPE html>
<html>
  <head>
    <title>Setting up you Raspberry Pi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="css/custom.css" rel="stylesheet">
  </head>
  <body>
    <script src="js/underscore-min.js"></script>
    <script src="js/jquery-2.0.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
	//alert("test");
      var oses = ['ubuntu', 'mac', 'win']
        , osNav

      $(function() {
        osNav = $('.nav')
        oses.forEach(function(os) {
          var osChoice = $('<li class="osChoice ' + os + '"><a href="?' + os + '">' + os + '</a></li>')
            .appendTo(osNav)
        })

        var selectedOs = location.search.slice(1) || 'ubuntu'
          , otherOses = _.difference(oses, [selectedOs])
          , otherOsesCSS = _.map(otherOses, function(os) { return '.' + os }).join(',')
        osNav.find('.osChoice').each(function(i, elem) {
          if ($(elem).hasClass(selectedOs)) {
            $(elem).addClass('active')
            $('#accordion').find('.' + selectedOs).show()
          } else {
            $(elem).removeClass('active')
            $('#accordion').find(otherOsesCSS).hide()
          }
        })

      })
    </script>

    <div id="container">

      <ul class="nav nav-pills">
      </ul>

      <div class="panel-group" id="accordion">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step1">
                <span class="stepIndex">1</span> Get a clean Raspbian image
              </a>
            </h2>
          </div>
          <div id="step1" class="panel-collapse collapse">
            <div class="panel-body">
              <p>First, download a clean <b>raspbian</b> image from the official RPI site <a href="http://www.raspberrypi.org/downloads">http://www.raspberrypi.org/downloads</a>. Then, unzip it.</p>
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step2">
                <span class="stepIndex">2</span> Start an emulator that will run this image
              </a>
            </h2>
          </div>
          <div id="step2" class="panel-collapse collapse">
            <div class="panel-body">
              <p>We need to customize the image we just downloaded, install programs and configure the system for our needs.</p>
              <p>For this, no need to install the image on the Pi yet. By using a machine emulator, we can fake a Raspberry Pi on our laptop, install our image there, and do all the configuration we need. We'll use a machine emulator called <a href="http://www.qemu.org">QEMU</a>. You also need a RPI Linux kernel compiled for QEMU, which you can get <a href="http://xecdesign.com/downloads/linux-qemu/kernel-qemu">here</a>.</p>

              <div class="win">
                <p>To configure our RPi image on Windows, we will need the following:</p>
                <ul>
                  <li><a href="http://downloads.raspberrypi.org/raspbian_latest">Raspbian Linux</a> image file</li>
                  <li><a href="http://xecdesign.com/downloads/linux-qemu/kernel-qemu">Linux kernel</a> for Qemu</li>
                  <li><a href="http://lassauge.free.fr/qemu/release/Qemu-1.6.0-windows.zip">Qemu</a> or Quick Emulator software for Windows. </li>
                </ul>
                <p>Create a working directory, e.g. <strong>C:\qemu</strong>. Unzip the Raspbian zip file and place the contents of it in <strong>C:\qemu</strong>. Move the kernel-qemu file to the same location. Unzip <strong>Qemu-1.6.0-windows.zip</strong> to <strong>C:\qemu</strong> as well</p>

                <p>We will need to create two .bat files in the <strong>C:\qemu</strong> directory:</p>
                <ol>
                <li><strong>rpi_setup.bat</strong> for setting up the image file so it can be emulated using Qemu;</li>
                <li><strong>rpi_start.bat</strong> for emulating and doing the rest of the setup we need.</li>
                </ol>
                <p>Let's start with adding content to the <strong>rpi_setup.bat</strong> file. Add the following:</p>
                <pre><code>qemu-system-armw -kernel kernel-qemu -cpu arm1176 -m 256 -M versatilepb -no-reboot -serial stdio -append "root=/dev/sda2 init=/bin/sh panic=1" -hda <strong>2013-09-25-wheezy-raspbian.img</strong></code></pre>
                
                <p>Note the <strong>2013-09-25-wheezy-raspbian.img</strong> part - change the filename to whatever your raspbian image file name is. Remember to save changes.</p>
                
                <p>Open the <strong>rpi_start.bat</strong> file. Add the same, except <strong>init=/bin/sh</strong>. It should look like this now:</p>

                <pre><code>qemu-system-armw -kernel kernel-qemu -cpu arm1176 -m 256 -M versatilepb -no-reboot -serial stdio -append "root=/dev/sda2 panic=1" -hda 2013-09-25-wheezy-raspbian.img</code></pre>

                <p>Save file and doubleclick on the <strong>rpi_setup.bat</strong>. A new window should open with a booting Linux system in it.</p>

                <p>Note: if the emulator fails to run:</p>

                <ol>
                  <li>Check if the path to your Raspbian image file is correct;</li>
                  <li>It might be necessary to add the <strong>C:\qemu</strong> location to Windows Path variable.</li>
                </ol>

                <p>Now you should see a plain and simple Linux shell in the emulator window. Execute these commands one by one there:</p>

                <pre><code>mount / -o remount,rw
echo > /etc/ld.so.preload
mount / -o remount,ro
exit</code></pre>
                
                <p>Enter these commands exactly as writen above or you will fail. The shell is very sensitive. This will remove all contents from the <strong>/etc/ld.so.preload</strong> file. Close the emulator window. Now the Raspbian .img file is ready to be booted.</p>

                <p>Doubleclick the <strong>rpi_start.bat</strong> file. The Raspbian Linux should start. When fully booted, a config screen with blue background should be visible. Do the following:</p>

                <ol>
                  <li>Change password;</li>
                  <li>Enable SSH;</li>
                  <li>And maybe overclock a bit.</li>
                </ol>

                <p>Exit the config tool by selecting <strong>Finish</strong> (navigate by using the Tab key), later you will be able to access the tool by issuing the <strong>sudo raspi-config</strong> command.</p>

                <p>If the system shuts down, click on the <strong>rpi_start.bat</strong> file again to restart the emulator.</p>

                <p>Now the image should be ready for burning on the SD card. To do that use <a href="https://www.sdcard.org/downloads/formatter_3/eula_windows">SDFormatter</a> to format the SD card and <a href="http://sourceforge.net/projects/win32diskimager/">Win32DiskImager</a> to burn the image file on to the SD card.</p>

                <p>Note that you have to select the ON option in the Format Size Adjustment select box in the <strong>SDFormatter</strong> application before you do the formatting. Be careful with selecting the correct drive letter as well.</p>
              </div>

              <p class="mac">Download <a href="http://sourceforge.net/projects/osxfuse/files/">OSXFUSE</a>. When installing, check the Compatibility Layer with MACFUSE (old version of OSXFUSE) option.</p>

              <p class="mac">Download <a href="http://sourceforge.net/projects/fuse-ext2/">FUSE-EXT2</a> binary. Install it and unmount the OSXFUSE and FUSE-EXT2 installation drives.</p>

              <p class="mac">Edit the FUSE-EXT2 auto mount script for read-write mounting. Open <b>/System/Library/Filesystems/fuse-ext2.fs/fuse-ext2.util</b> and around line 207 (in function Mount ()) you will find the line</p>
              <pre class="mac"><code>OPTIONS="auto_xattr,defer_permissions"</code></pre>
              <p class="mac">Change that line to:</p>
              <pre class="mac"><code>OPTIONS="auto_xattr,defer_permissions,rw+"</code></pre>
              <p class="mac">Save file, restart Terminal and navigate to your RPi workshop directory. Run:</p>
              <pre class="mac"><code>sudo hdiutil mount your-rpi-image.img</code></pre>
              <p class="mac">You should see something like this:</p>
              <pre class="mac"><code>/dev/disk1         FDisk_partition_scheme          
/dev/disk1s1        Windows_FAT_32        /Volumes/boot
/dev/disk1s2        Linux                 /Volumes/Untitled</code></pre>
              <p class="mac">Navigate to the mounted Linux partition:</p>
              <pre class="mac"><code>cd /Volumes/Untitled</code></pre>
              <p class="mac">Run:</p>
              <pre class="mac"><code>sudo nano etc/ld.so.preload</code></pre>
              <p class="mac">Comment out the only line there so it looks like this:</p>
              <pre class=""><code>#/usr/lib/arm-linux-gnueabihf/libcofi_rpi.so</code></pre>
              <p class="">Press Ctrl+X <span class="mac">(Not Cmd+X) </span>to save file and exit.</p>

              <p class="mac">Before installing QEMU, make sure that you have <a href="http://www.macports.org">MACPORTS</a>. MACPORTS depend on XCode Command Line Tools that depend on XCode. To get XCode, go to <a href="https://developer.apple.com">Apple Developer</a> website or use App Store application. XCode Command Line tools are only available through Apple Developer website.</p>

              <p>Now, do this to install QEMU:</p>

              <pre class="ubuntu"><code>sudo apt-get install qemu-system</code></pre>
              <pre class="mac"><code>sudo port install qemu +target_arm</code></pre>

              <p class="ubuntu">Now, we need to launch it and run our image. First, execute:</p>
              <pre class="ubuntu"><code>file your-raspbian.img</code></pre>

              <p class="ubuntu">From the output of this command, take the partition 2 'startsector' value and multiply by 512, and use this figure as the offset value in the mount command below.</p>
              <pre class="ubuntu"><code>sudo mount your-raspbian.img -o offset=62914560 /mnt
nano /mnt/etc/ld.so.preload
</code></pre>
                
              <p class="ubuntu">Comment out the line in the file and save. Then unmount the image.</p>
              <pre class="ubuntu"><code>sudo umount your-raspbian.img</code></pre>

              <p>Make sure that you are in workshop working directory, then, you can start QEMU with your image:</p>
              <pre class=""><code><span class="mac">sudo </span>qemu-system-arm -kernel your-linux-kernel -cpu arm1176 -m 256 -M versatilepb -no-reboot -serial stdio -append "root=/dev/sda2 panic=1" -hda your-raspbian.img -redir tcp:5022::22</code></pre>

              <p class="ubuntu">If it says that running fsck failed, just run</p>
              <pre class="ubuntu"><code>fsck /dev/sda2</code></pre>
              <p class="ubuntu">and restart the emulator when done.</p>

              <p>Because this is the first time we start the image on a machine, you will be prompted with a menu allowing you to configure some options. Don't forget to change your password, and to change the keyboard layout.</p>

              <p class="references">
                References
                <ul>
                  <li><a href="http://www.raspberrypi.org/phpBB3/viewtopic.php?f=29&t=37386">http://www.raspberrypi.org/phpBB3/viewtopic.php?f=29&t=37386</a></li>
                  <li><a href="http://xecdesign.com/">http://xecdesign.com/</a></li>
                  <li class="mac"><a href="http://www.thewireframecommunity.com/node/174">http://www.thewireframecommunity.com/node/174</a></li>
                </ul>
              </p>
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step3">
                <span class="stepIndex">3</span> Install packages
              </a>
            </h2>
          </div>
          <div id="step3" class="panel-collapse collapse">
            <div class="panel-body">
              <p>To install all the packages we need, run the following commands in the emulator :</p>
              <pre><code>sudo apt-get update
sudo apt-get install puredata
sudo apt-get install pd-hid
sudo apt-get install git</pre></code>
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step4">
                <span class="stepIndex">4</span> Enable SSH connections
              </a>
            </h2>
          </div>
          <div id="step4" class="panel-collapse collapse">
            <div class="panel-body">
              <p>Running the Raspbian image on a virtual machine is fine for the configuration phase, but we also need to have an access to the system while it is running on the board. For this we will use SSH.</p>

              <p>SSH is already enabled on the last Raspbian versions, but we need to make sure the SSH client is running when we boot the Pi. To do that, run the following command in the emulator :</p>

              <pre><code>sudo update-rc.d ssh defaults</pre></code>

              <p>Then, as we will connect directly the Pi to our computer through a network cable, we need to configure a network. We will assign our Pi a static IP address, so we can find it from our laptop. For this open the file <b>/etc/network/interfaces</b> in the nano text editor:</p>

                <pre><code>sudo nano /etc/network/interfaces</code></pre>

                <p>Replace the contents of it with the following:</p>

                <pre><code>auto lo
iface lo inet loopback
auto eth0
iface eth0 inet static

address 192.168.0.210   # your IP  
gateway 192.168.0.1     # IP of the Router
netmask 255.255.255.0   # Network mask</code></pre>

                <p>Press <strong>Ctrl+X</strong> to save and exit. The program will prompt you whether you want to save chenges - enter 'y' for 'yes' and hit Enter. Run the following command to shutdown:</p>

                <pre><code>sudo halt</code></pre>

              <p class="references">
                References
                <ul>
                  <li><a href="http://cplus.about.com/od/raspberrypi/a/How-Do-I-Setup-Ssh-On-Raspberry-Pi.htm">http://cplus.about.com/od/raspberrypi/a/How-Do-I-Setup-Ssh-On-Raspberry-Pi.htm</a></li>
                  <li><a href="http://elinux.org/RPi_Setting_up_a_static_IP_in_Debian">http://elinux.org/RPi_Setting_up_a_static_IP_in_Debian</a></li>
                </ul>
              </p>

            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step5">
                <span class="stepIndex">5</span> Copy the workshop files
              </a>
            </h2>
          </div>
          <div id="step5" class="panel-collapse collapse">
            <div class="panel-body">
              <p>Our system is almost ready. Last thing we need to do is copy the workshop files. For this, simply clone the workshop git repository :</p>
  
              <pre><code>git clone https://github.com/sebpiq/pd-rpi-workshop.git</code></pre>
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step6">
                <span class="stepIndex">6</span> Install the image to your SD card
              </a>
            </h2>
          </div>
          <div id="step6" class="panel-collapse collapse">
            <div class="panel-body">

              <p>The first thing we need to do is format the SD card to FAT32 (beware, this will erase all your data). <span class="ubuntu">For this, just open the disk utilities, find your SD card there, remove all existing partitions, and create a new one. When this is done, eject the card from the reader.</span></p> 

              <p>Now, you need to find the name of your SD card on your computer. But, don't insert the card yet and run :</p> 
              <pre><code>df -h</code></pre>

              <p>Now insert the card and run the same command. The new partitions appearing in the list correspond to your SD Card. Unmount all these partitions using the <b><span class="ubuntu">umount</span><span class="mac">diskutil unmount</span></b> command</p>

              <p>Finally, let's install the image to the SD card. Now be very careful. You need to input the right device name or you might lose all the data on your computer (no joke).</p>
              <pre><code>dd bs=1m if=your-raspbian.img of=/dev/your-device-name</code></pre>
              <p>This should take a couple of minutes, so be patient even if nothing seems to happen.</p>

              <p class="references">
                Reference

                <a href="http://elinux.org/RPi_Easy_SD_Card_Setup">http://elinux.org/RPi_Easy_SD_Card_Setup</a>
              </p>
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step7">
                <span class="stepIndex">7</span> Test that everything works
              </a>
            </h2>
          </div>
          <div id="step7" class="panel-collapse collapse">
            <div class="panel-body">

              <h3>Connectivity</h3>
              <p>First, let's test that we can connect to the Pi using SSH. For this set a static IP on your computer in the same network as the Pi. For example address <b>100.100.100.3</b>, gateway <b>100.100.100.1</b> and netmask <b>255.255.255.0</b>.<span class="ubuntu"> This can be done through the network manager top right of your screen, menu "edit connections".</span></p>
              <p>Then, connect a network cable to the Pi, and try connecting through SSH</p>
              <pre><code>ssh pi@100.100.100.2</code></pre>

              <h3>Sound output</h3>
              <p>Plug-in your usb interface, and plug some speakers or headphones to its output. Then, have Pd print the list of audio devices :</b>
              <pre><code>pd -nogui -listdev</code></pre>

              <p>Press `ctrl+c` to stop pd. Note the number of your output device and the start again pd this time telling it what device you want to use for output. For example my usb dongle output is device number 3 :</p>
              <pre><code>pd -nogui -audiooutdev 3 soundcheck.pd</pre></code>

              <h3>Sound input</h3>
              <p>Start pd specifying sound input and sound output (because you presumably want the input/output to go through the same usb device), and optionally the number of channels (my usb dongle only works with 1 channel) :</p>
              <pre><code>pd -nogui -audiodev 3 -inchannels 1 miccheck.pd</code></pre>

              <h3>Controller</h3>
              <p>Plug-in a mouse to your Pi. To listen to the events from a device, you will need its number. To print all connected devices, execute :</p>
              <pre><code>pd -nogui controllercheck.pd</code></pre>
              
              <p>Write down the number of your mouse, and now execute (my mouse is device 4) :</p>
              <pre><code>pd -send ";deviceNum 4" -nogui controllercheck.pd</code></pre>

              <p class="references">
                References

                <ul>
                  <li><a href="http://wiki.linuxaudio.org/wiki/raspberrypi">http://wiki.linuxaudio.org/wiki/raspberrypi</a></li>
                  <li><a href="http://puredata.info/docs/tutorials/HowToReadHIDDevicesInLinuxWithoutBeingRoot/">http://puredata.info/docs/tutorials/HowToReadHIDDevicesInLinuxWithoutBeingRoot/</a></li>
                </ul>
              </p>

            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#step8">
                <span class="stepIndex">8</span> Setup Pd to start on boot
              </a>
            </h2>
          </div>
          <div id="step8" class="panel-collapse collapse">
            <div class="panel-body">
              <h3>Auto-login the pi user</h3>
              <p>Run</p>
              <pre><code>sudo nano /etc/inittab</code></pre>

              <p>Comment the line starting the terminal tty1 ("1:2345:respawn:/sbin/getty 115200 tty1"), and just bellow it add :</p>
              <pre><code>1:2345:respawn:/bin/login -f pi tty1 </dev/tty1 >/dev/tty1 2>&1</pre></code>

              <h3>Starting a program on boot</h3>
              <p>In <b>/home/pi</b> create an executable shell script called <b>startup.sh</b> :</p>
              <pre><code>touch startup.sh
chmod a+x startup.sh</code></pre>

              <p>Then open <b>.bashrc</b> and add the following line at the end of the file :</p>
              <pre><code>~/startup.sh</pre></code>
              
              <p>Now whatever commands are in <b>startup.sh</b> are exectued on boot of the system. We want to run a Pd patch, so open <b>startup.sh</b> and paste the following inside : </p>
              <pre><code>#!/bin/bash
pd -send ";deviceNum 4" -nogui -audiooutdev 3 controllercheck.pd</code></pre>

              <p>Now to test that this works, reboot your Pi by running :</p>
              <pre><code>sudo shutdown -r 0</code></pre>

              <p class="references">
                Reference <a href="http://elinux.org/RPi_Debian_Auto_Login">http://elinux.org/RPi_Debian_Auto_Login</a>
              </p>
            </div>
          </div>
        </div>

      </div>

    </div>

  </body>
</html>

